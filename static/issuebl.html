<!doctype html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="keywords" content="title, electronic, bill of lading">
        <meta name="description" content="The Registry">
        <meta name="robots" content="all">
        <meta charset="utf-8">
        <link rel="icon" href="images/logo-simple.jpg">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="jsrsasign-latest-all-min.js"></script>
        <script src="transportdocumenttransfer.js"></script>
        <script src="testkeys.js"></script>
        <link href="custom.css" rel="stylesheet">
        <title>Title Registry</title>
        <style>
            #menuList {margin-left: auto; margin-right: 20px !important;}
            .navbar {margin-bottom: 25px;}
        </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-default navbar-dark shadow">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">The Registry</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul id="menuList" class="navbar-nav me-auto mb-2 mb-lg-0">
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container" id="supportingText">
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Issue Transport Document</h5>
                        <p class="card-text">
                    Carrier's Document Reference: <input type="text" class="form-control" id="carrierDocumentReference"><br>
                    Load Port: <input type="text" class="form-control" id="loadPort"><br>
                    Discharge Port: <input type="text" class="form-control" id="dischargePort"><br>
                    Commodity: <input type="text" class="form-control" id="commodity"><br>
                    Vessel: <input type="text" class="form-control" id="vesselName"><br>
                    Voyage: <input type="text" class="form-control" id="voyageNumber"><br>
                    Document Type: <select class="form-select" aria-label="BL Type">
                        <option value="2" disabled="true">Generic document</option>
                        <option value="1">DCSA eBL</option>
                        </select><br>
                    Endorsement Type: <select class="form-select" aria-label="Endorsement Type">
                        <option value="1">To order</option>
                        <option value="2">To order of consignee</option>
                        <option value="3">To order of bank</option>
                        <option value="4">Straight</option>
                        </select><br>
                    Consignee
                    <input type="text" class="form-control" placeholder="Consignee public key"><br>
                    Upload document or paste in its hash:
                    <input type="file" class="form-control" id="customFile" />
                    <input type="text" class="form-control" placeholder="Document hash (SHA256)"><br>
                        </p>
                    </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-7">
                    <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Issue to shipper with public key</h5>
                        <textarea class="form-control" id="shipperPublicKeytextArea" rows="4"></textarea>
                        <p class="card-text">Signing with carrier private key:</p>
                        <textarea class="form-control" id="carrierPrivateKeytextArea" rows="4"></textarea>
                        <button type="button" class="btn btn-primary" id="post-btn">
                            Issue
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        window.onload = function(){
            document.getElementById("carrierPrivateKeytextArea").value = carrierPrivateKey;
            document.getElementById("shipperPublicKeytextArea").value = shipperPublicKey;

            const button = document.getElementById('post-btn');
            button.addEventListener('click', async _ => {
                var arrayEncoder = new TextEncoder(); // always utf-8
                const transportDocument = {
                    documentReference: document.getElementById("carrierDocumentReference").value,
                    portOfLoad: document.getElementById("loadPort").value,
                    portOfDischarge: document.getElementById("dischargePort").value,
                    commodity: document.getElementById("commodity").value,
                    vessel: document.getElementById("vesselName").value,
                    voyage: document.getElementById("voyageNumber").value
                }
                console.log(transportDocument);
                const stringifiedTransportDocument = JSON.stringify(transportDocument);
                const documentHash = ArrayBuffertohex(await crypto.subtle.digest('SHA-256', arrayEncoder.encode(stringifiedTransportDocument)));
                await fetch('/api/v1/addTransportDocument', {
                method: 'post',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    documentHash : documentHash,
                    transportDocumentJson: JSON.stringify(transportDocument)
                    })
                });

                const shipperPublicKeyFromPem = KEYUTIL.getKey(document.getElementById("shipperPublicKeytextArea").value);
                const shipperPublicKeyJWK = KEYUTIL.getJWKFromKey(shipperPublicKeyFromPem);
                var carrierPrivateKeyFromPem = new RSAKey();
                carrierPrivateKeyFromPem.readPrivateKeyFromPEMString(document.getElementById("carrierPrivateKeytextArea").value);
                const carrierPublicKeyFromPem = KEYUTIL.getKey(carrierPublicKey);
                const issueBLtdt = new TransportDocumentTransfer()
                issueBLtdt.createTdt(shipperPublicKeyJWK, shipperPublicKeyJWK, documentHash, true, null, carrierPrivateKeyFromPem);
                const isValid2 = KJUR.jws.JWS.verifyJWT(issueBLtdt.asJWT(), carrierPublicKeyFromPem, {alg: ['RS256']});
                console.log("valid JWT?: ", isValid2);
                await fetch('/api/v1/addTransportDocumentTransfer', {
                method: 'post',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tdtHash : await issueBLtdt.tdtHash(),
                    transportDocumentTransfer: issueBLtdt.asJWT()
                    })
                });
                location.href = "transportdocumenttransfer.html?id=" + await issueBLtdt.tdtHash();
            });
        }
    </script>
</html>
