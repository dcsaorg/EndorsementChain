<!doctype html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="keywords" content="title, electronic, bill of lading">
        <meta name="description" content="The eBL Platform">
        <meta name="robots" content="all">
        <meta charset="utf-8">
        <link rel="icon" href="images/logo-simple.jpg">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="jsrsasign-latest-all-min.js"></script>
        <script src="transportdocumenttransfer.js"></script>
        <script src="testkeys.js"></script>
        <script src="blfields.js"></script>
        <link href="custom.css" rel="stylesheet">
        <title>Title eBL Platform</title>
        <style>
            #menuList {margin-left: auto; margin-right: 20px !important;}
            .navbar {margin-bottom: 25px;}
        </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-default navbar-dark shadow">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">The eBL Platform</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul id="menuList" class="navbar-nav me-auto mb-2 mb-lg-0">
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container" id="supportingText">
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Issue Transport Document</h5>
                        <p class="card-text" id="blFields">
                            Carrier's Document Reference: <input type="text" class="form-control" id="blno"><br>
                            Port Of Loading: <input type="text" class="form-control" id="portOfLoading"><br>
                            Port Of Discharge: <input type="text" class="form-control" id="portOfDischarge"><br>
                            Vessel: <input type="text" class="form-control" id="vessel"><br>
                            Voyage: <input type="text" class="form-control" id="voyageNo"><br>
                            Shipper: <textarea class="form-control" id="shipper" rows="4"></textarea><br>
                            Export Import Svc Ref: <input type="text" class="form-control" id="exportImportSvcRef"><br>
                            Forwarding Agent References: <textarea class="form-control" id="forwardingAgentReferences" rows="4"></textarea><br>
                            Consignee: <textarea class="form-control" id="consignee" rows="4"></textarea><br>
                            Notify Party: <textarea class="form-control" id="notifyParty" rows="4"></textarea><br>
                            Also Notify Party: <textarea class="form-control" id="alsoNotifyParty" rows="4"></textarea><br>
                            Booking No/ Carrier Ref: <input type="text" class="form-control" id="bookingNoCarrierRef"><br>
                            Pre-carriage by: <input type="text" class="form-control" id="preCarriageBy"><br>
                            Place of Receipt: <input type="text" class="form-control" id="placeOfReceipt"><br>
                            Place of Delivery: <input type="text" class="form-control" id="placeOfDelivery"><br>
                            Onward Inland Routing Final Destination: <input type="text" class="form-control" id="onwardInlandRoutingFinalDestination"><br>
                            Container Numbers: <textarea class="form-control" id="containerNumbers" rows="4"></textarea><br>
                            Size/Types: <input type="text" class="form-control" id="sizeTypes"><br>
                            Seal Nos: <textarea class="form-control" id="sealNos" rows="4"></textarea><br>
                            Description Of Goods: <textarea class="form-control" id="descriptionOfGoods" rows="10"></textarea><br>
                            Cargo Gross Weights: <textarea class="form-control" id="cargoGrossWeights" rows="4"></textarea><br>
                            Receipt Delivery Type: <input type="text" class="form-control" id="receiptDeliveryType"><br>
                            Cargo Movement Type: <input type="text" class="form-control" id="cargoMovementType"><br>
                            Is Part Load: <input type="text" class="form-control" id="isPartLoad"><br>
                            HS Code: <input type="text" class="form-control" id="hsCode"><br>
                            Reefer Settings: <input type="text" class="form-control" id="reeferSettings"><br>
                            Point And Country Of Origin Of Goods: <input type="text" class="form-control" id="pointAndCountryOfOriginOfGoods"><br>
                            Shipper Declared Value: <input type="text" class="form-control" id="shipperDeclaredValue"><br>
                            Freight And Charges Payable By At: <input type="text" class="form-control" id="freightAndChargesPayableByAt"><br>
                            Freight And Charges: <input type="text" class="form-control" id="freightAndCharges"><br>
                            Basis: <input type="text" class="form-control" id="basis"><br>
                            Rate: <input type="text" class="form-control" id="rate"><br>
                            Prepaid: <input type="text" class="form-control" id="prepaid"><br>
                            Collect: <input type="text" class="form-control" id="collect"><br>
                            Total Freight: <input type="text" class="form-control" id="totalFreight"><br>
                            Carrier Clauses: <input type="text" class="form-control" id="carrierClauses"><br>
                            Total Number Of Containers Received: <input type="text" class="form-control" id="totalNumberOfContainersReceived"><br>
                            Place Of Issue: <input type="text" class="form-control" id="placeOfIssue"><br>
                            Shipped On Board Date: <input type="text" class="form-control" id="shippedOnBoardDate"><br>
                            Date Of Issue: <input type="text" class="form-control" id="dateOfIssue"><br>
                            No And Sequence Of Original BLs: <input type="text" class="form-control" id="noAndSequenceOfOriginalBLs"><br>
                            Endorsement Type: <select class="form-select" aria-label="Endorsement Type">
                                <option value="1">To order</option>
                                <option value="2">To order of consignee</option>
                                <option value="3">To order of bank</option>
                                <option value="4">Straight</option>
                                </select><br>
                        </p>
                    </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-7">
                    <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Issue to shipper with public key</h5>
                        <textarea class="form-control" id="shipperPublicKeytextArea" rows="4"></textarea>
                        <p class="card-text">Signing with carrier private key:</p>
                        <textarea class="form-control" id="carrierPrivateKeytextArea" rows="4"></textarea>
                        <button type="button" class="btn btn-primary" id="post-btn">
                            Issue
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        window.onload = function(){
            document.getElementById("carrierPrivateKeytextArea").value = carrierPrivateKey;
            document.getElementById("shipperPublicKeytextArea").value = shipperPublicKey;
            const button = document.getElementById('post-btn');
            button.addEventListener('click', async _ => {
                var arrayEncoder = new TextEncoder(); // always utf-8
                var transportDocument = {};
                blFields.forEach(function(field) {
                    console.log(field);
                    transportDocument[field] = document.getElementById(field).value;
                });
                console.log(transportDocument);
                const stringifiedTransportDocument = JSON.stringify(transportDocument);
                const documentHash = ArrayBuffertohex(await crypto.subtle.digest('SHA-256', arrayEncoder.encode(stringifiedTransportDocument)));
                await fetch('/api/v1/transport-documents', {
                method: 'post',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    documentHash : documentHash,
                    transportDocumentJson: JSON.stringify(transportDocument)
                    })
                });

                const shipperPublicKeyFromPem = KEYUTIL.getKey(document.getElementById("shipperPublicKeytextArea").value);
                const shipperPublicKeyJWK = KEYUTIL.getJWKFromKey(shipperPublicKeyFromPem);
                var carrierPrivateKeyFromPem = new RSAKey();
                carrierPrivateKeyFromPem.readPrivateKeyFromPEMString(document.getElementById("carrierPrivateKeytextArea").value);
                const carrierPublicKeyFromPem = KEYUTIL.getKey(carrierPublicKey);
                const issueBLtdt = new TransportDocumentTransfer()
                issueBLtdt.createTdt(shipperPublicKeyJWK, shipperPublicKeyJWK, documentHash, true, null, carrierPrivateKeyFromPem, null);
                let verifierJWT = new KJUR.jws.JWSJS();
                verifierJWT.readJWSJS(issueBLtdt.asJWT())
                const isValid2 = verifierJWT.verifyNth(0, carrierPublicKeyFromPem, {alg: ['RS256']});
                console.log("valid JWT?: ", isValid2);
                await fetch('/api/v1/transport-document-transfers', {
                method: 'post',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tdtHash : await issueBLtdt.tdtHash(),
                    transportDocumentTransfer: JSON.stringify(issueBLtdt.asValidJWT())
                    })
                });
                location.href = "transportdocumenttransfer.html?id=" + await issueBLtdt.tdtHash();
            });
        }
    </script>
</html>
