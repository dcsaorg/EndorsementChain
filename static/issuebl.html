<!doctype html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="keywords" content="title, electronic, bill of lading">
        <meta name="description" content="The Registry">
        <meta name="robots" content="all">
        <meta charset="utf-8">
        <link rel="icon" href="images/logo-simple.jpg">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="jsrsasign-latest-all-min.js"></script>
        <script src="transportdocumenttransfer.js"></script>
        <link href="custom.css" rel="stylesheet">
        <title>Title Registry</title>
        <style>
            #menuList {margin-left: auto; margin-right: 20px !important;}
            .navbar {margin-bottom: 25px;}
        </style>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-default navbar-dark shadow">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">The Registry</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul id="menuList" class="navbar-nav me-auto mb-2 mb-lg-0">
                    </ul>
                </div>
            </div>
        </nav>
        <div class="container" id="supportingText">
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Issue Transport Document</h5>
                        <p class="card-text">
                    Carrier's Document Reference: <input type="text" class="form-control" id="carrierDocumentReference"><br>
                    Load Port: <input type="text" class="form-control" id="loadPort"><br>
                    Discharge Port: <input type="text" class="form-control" id="dischargePort"><br>
                    Commodity: <input type="text" class="form-control" id="commodity"><br>
                    Vessel: <input type="text" class="form-control" id="vesselName"><br>
                    Voyage: <input type="text" class="form-control" id="voyageNumber"><br>
                    Document Type: <select class="form-select" aria-label="BL Type">
                        <option value="2" disabled="true">Generic document</option>
                        <option value="1">DCSA eBL</option>
                        </select><br>
                    Endorsement Type: <select class="form-select" aria-label="Endorsement Type">
                        <option value="1">To order</option>
                        <option value="2">To order of consignee</option>
                        <option value="3">To order of bank</option>
                        <option value="4">Straight</option>
                        </select><br>
                    Consignee
                    <input type="text" class="form-control" placeholder="Consignee public key"><br>
                    Upload document or paste in its hash:
                    <input type="file" class="form-control" id="customFile" />
                    <input type="text" class="form-control" placeholder="Document hash (SHA256)"><br>
                        </p>
                    </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-7">
                    <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Issue to shipper with public key</h5>
                        <textarea class="form-control" id="shipperPublicKeytextArea" rows="4"></textarea>
                        <p class="card-text">Signing with carrier private key:</p>
                        <textarea class="form-control" id="carrierPrivateKeytextArea" rows="4"></textarea>
                        <button type="button" class="btn btn-primary" id="post-btn">
                            Issue
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        //note: all keys here are for test purposes only
        const carrierPrivateKey = `-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEAxpFsixidx12u3sB6ZpQYn8IcuIYjBfGM0Rlu3TooZHOkA5Hb
pvRvsaj/HTVKCCQdw1PqJ0S+caZDDjCWyGOXhDfxP0J04C3U21k2KwyS+6bBh+8F
VAZSjzGikX+ZOZ35RykLF8YyqO4+R1t8pxAnNLbNJCR3ezTN2LEcwUfjYc6ohgIe
8KiBbUO/J3TAr0XoftkCfVO0wufFr59BYF0Qiw2y2Zx8FdjrUX0ygqRwkS8SV9Iv
fUJbLj5oOK21kyVfxhShI2SQgid8rX/K9k3dMNuka4CMArOGM1YtpuM9q5f1Vp3l
wSbpD7Eo+i4Lf2knCqJQzgGZGZy2cCRUq1/6wQIDAQABAoIBAQC7uvFr8DH7Ms8J
OeB+6rT9FYAh1G94Rw5jAjCWZ02Y6tu9pECOb7rJtIS9EIyVdc/Nw6A00AFdYVs0
Jyvm+IFfN6SVsjbdW3dKieV0fcbYtKdz5L6c2f1j9AFGneQ3XOs4I82hBHkQzW2D
+TK4n8TxSYJZEUEE8r9Khugws859wEFWnkLClxdniV8kcnJQv1R6j0jvBopBbzaO
GHisyTP3XDj/jrGH7EUOMqhYORMBDi5U6Oj+CDGL8aVP0xENJP5WHCCH6qxdPnzH
89+z5LMkcoPdHE1OWB+ydJkB9eWy6riUQKbvCtJAL+CBE0NoFyb/pI7RlYDCDQZB
hlw7KE4BAoGBAOrcnjn0fytY4izRkTuzgXHiy31PX+4JC/Ps/zZbRej8rECaVwaa
oU+wtcZ/dW0oY7k3tGNhfbik1oe47Y7m9X38yzEVYR2FcOrmSVmPIbLtu6GQrMHR
mYaH/0FsT1ceD0lXBjR2XJ92Hdp76YJinWClJCpFXcUs28ljgBOcikCpAoGBANhw
kqBlMrcY+O3vnUkkrlQxaAogxBuTHSIf6AnwwTZLtfZ6mpFAheyh1oAY3GYqJyP2
Z+l/WojevKd5u7fgSZ3IQITUKA4Kt1JBcS49NZbfHVUgb/22HqrX2FAwVe0xelhg
iJtg/rSEDHpq4fv+LYSoaV29rFAb5a4nhzWVA4BZAoGBANlQ9HOJ4ZXZc8amz2zf
hzo68bFsncYixtWZCPlh8UlJa5WHelkZAYQ8baZTT/OGOOgsPBTtI6iTlhIVsnLV
EHjYTaeIMclgLQCdv2dIQpVO1pwDw2bAK//InQ8LSkrA/MIO7SXkE4ZVhAAjQgks
eJTxmYonj0GgZWpuUBdVdLOpAoGALl8H+xdTY0kVZBzXLOmP8/fV232jpmjBcCM3
2pFbQ9+6r4EbBo21Y7pUs4MgDT9wvVK4dp1Tb0mRT6xUHJQQEZ7qu8qcfk2rcxMU
RZzVk2pf5XIarFfNgDrYXG3Oqw/Tr4WXHvsL9u7noX6uxgdyBx7x3CSb+1nOvp43
aLJxWpkCgYEAi45NjUIk7j1YxGzBisKGCrOPmyCQueodyRjVvNHU631S4N0D1DVj
sfcBasos+cFhgTS0wBWEMkIfR+5T7uR/1MPULeLi+hFUeIKOkhVo8sO6WclinoOf
5PaWVzt/y3+deM4Qrd4OxG7EOxqc6/QIaVuxoBrwvAydpCZ5t1eONDk=
-----END RSA PRIVATE KEY-----
`;

        const carrierPublicKey = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxpFsixidx12u3sB6ZpQY
n8IcuIYjBfGM0Rlu3TooZHOkA5HbpvRvsaj/HTVKCCQdw1PqJ0S+caZDDjCWyGOX
hDfxP0J04C3U21k2KwyS+6bBh+8FVAZSjzGikX+ZOZ35RykLF8YyqO4+R1t8pxAn
NLbNJCR3ezTN2LEcwUfjYc6ohgIe8KiBbUO/J3TAr0XoftkCfVO0wufFr59BYF0Q
iw2y2Zx8FdjrUX0ygqRwkS8SV9IvfUJbLj5oOK21kyVfxhShI2SQgid8rX/K9k3d
MNuka4CMArOGM1YtpuM9q5f1Vp3lwSbpD7Eo+i4Lf2knCqJQzgGZGZy2cCRUq1/6
wQIDAQAB
-----END PUBLIC KEY-----
`;

        const shipperPrivateKey = `-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAi71OOBsnD8kQpjDD3J/VIBhxdz53/4y3y54rWNsOCJR2ji+g
Z3872L5D9yOHqp3BFdh0exeXzV/sFRLy3iWSb/D+9gWnJozGdJSXwG4n6yAVkzeH
booMJ/1p3ORoM5RSfiDNiGh0xdNL0l/50yFCkOksvIIEu8++ecXocq7xRcGIHYa6
qQJUEwKA2giSdGMW769fYVHM05fpiSKqr4txuIX/P74BGRg0SIe/i2tFP0cM0Eya
qCqgBTGPa6x7gqs6miiGkIExO4vUbtofBPpm+usxXGeoD2Ll0FOTzWz1MYQwwIvN
hYuFaLcv+mmygnAJiuUDJtdwxez5++G1ZSfCyQIDAQABAoIBAB/xXSD8K/iyyIiE
2zDipHBaxg0xDXMwMo9sD5KXOGUDsvobrvoZno+UJqsmxwtcVlftC+tbYEsFI01J
8JSRWCEYoN+SOTxZr7/Ue7/0LlHUGrp1VhMRoWe+yOVCnQM1Y4oLa5BD+HWEMG/d
mpkFoFbJxn0s53IbMfpaICGfFe4Q0GYeaTZTgVqN8RCsGQLdqvW7eVAtNoULfekd
BmDryY+jH7gTozvvT0zEZsskMi6C4C9Ze8BY0W8n1nnTVxK3lPcqoeKfWwgLi4vp
Gwkb4e+KHzNTs8zwGikCY44mbbrRwQDzHs4qHCVTVnyLxtx9MpjsxgD+wL8GGWD1
3j6oVtUCgYEA4xNLHkGHNGXkDTLmehOtyiZnzZRa3oztUe0HcDjp919jCsZGTt2X
JhJ9qomyUYRaMAWHjjKXlWqqlou7bbWiJ/Kzu1gRh3rUhHRlUkX8+/gC9ngk4OU4
bvWvVd5KmhMM/wkqDHcqrYCyksBL8to1e96YWIswaONT9j9n3Kr7L8sCgYEAnYoS
4kQHDF2M/EfP0gabZaSVY5DOAmszdAnmXaYvSRwIvESBOedi20CfRUE9akbcRmB8
cE8mbo25M3WR7M1q0sylsx8f0LlxlP2BAHOdYYUnPTU+eDStRgxGE2AAtgqrSEuJ
D7nTp4n5CBCsLDtS63xcRO+/ijRVcMaWiMvVXTsCgYEAv+g/VPu2Y481E/6PkF5v
QugAVFrsDSf3LYTwA2TmPv0rfCCjrOVTZ4a7E9S5knETs4AI1yFkwI9cSk0fgxG9
UJuqUEuWzPP/BU5Fjym9K8mn31scd8DhV81leGGclOhC1IuPMOfJdsbMpH/F8CGA
kAZIpJRFvm9ZN0TQ50rNbM8CgYB9hdhKBJ4BEkEVejpyQ+VpdVu6e1RJxRS4LnMo
xxMCE546M/MrKdwwiirdSYAfv9ofER3VdptOlwmroM/meD3XPEwCjpgQ/NEtP1eb
/oK1gxyivlvJ917gY0MqiOHIKnQTJGxO5WdpJJwR+wbUL2iATRRPsR9ShSRWuUSU
NqUIpQKBgEHk+deRSFMV8oyUr6rgerpof4oWY53/aIO8Utbj5EHMwapqd7QS792P
6/mOw4BOnJsIkoAvsrGAYERfRhDJYTTzicKmv9599dGx6zr8CEUp+uqupaJFiicx
id3RIR+/GcrcwT3MJLqVagLbKigoUm42teZ2TXlhPouZ/5CL1dhc
-----END RSA PRIVATE KEY-----
`;

        const shipperPublicKey = `------BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi71OOBsnD8kQpjDD3J/V
IBhxdz53/4y3y54rWNsOCJR2ji+gZ3872L5D9yOHqp3BFdh0exeXzV/sFRLy3iWS
b/D+9gWnJozGdJSXwG4n6yAVkzeHbooMJ/1p3ORoM5RSfiDNiGh0xdNL0l/50yFC
kOksvIIEu8++ecXocq7xRcGIHYa6qQJUEwKA2giSdGMW769fYVHM05fpiSKqr4tx
uIX/P74BGRg0SIe/i2tFP0cM0EyaqCqgBTGPa6x7gqs6miiGkIExO4vUbtofBPpm
+usxXGeoD2Ll0FOTzWz1MYQwwIvNhYuFaLcv+mmygnAJiuUDJtdwxez5++G1ZSfC
yQIDAQAB
-----END PUBLIC KEY-----
`;

        window.onload = function(){
            document.getElementById("carrierPrivateKeytextArea").value = carrierPrivateKey;
            document.getElementById("shipperPublicKeytextArea").value = shipperPublicKey;

            const button = document.getElementById('post-btn');
            button.addEventListener('click', async _ => {
                var arrayEncoder = new TextEncoder(); // always utf-8
                const transportDocument = {
                    documentReference: document.getElementById("carrierDocumentReference").value,
                    portOfLoad: document.getElementById("loadPort").value,
                    portOfDischarge: document.getElementById("dischargePort").value,
                    commodity: document.getElementById("commodity").value,
                    vessel: document.getElementById("vesselName").value,
                    voyage: document.getElementById("voyageNumber").value
                }
                console.log(transportDocument);
                const stringifiedTransportDocument = JSON.stringify(transportDocument);
                const documentHash = ArrayBuffertohex(await crypto.subtle.digest('SHA-256', arrayEncoder.encode(stringifiedTransportDocument)));
                await fetch('/api/v1/addTransportDocument', {
                method: 'post',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    documentHash : documentHash,
                    transportDocumentJson: JSON.stringify(transportDocument)
                    })
                });

                const shipperPublicKeyFromPem = KEYUTIL.getKey(document.getElementById("shipperPublicKeytextArea").value);
                const shipperPublicKeyJWK = KEYUTIL.getJWKFromKey(shipperPublicKeyFromPem);
                var carrierPrivateKeyFromPem = new RSAKey();
                carrierPrivateKeyFromPem.readPrivateKeyFromPEMString(document.getElementById("carrierPrivateKeytextArea").value);
                const carrierPublicKeyFromPem = KEYUTIL.getKey(carrierPublicKey);
                const issueBLtdt = new TransportDocumentTransfer(shipperPublicKeyJWK, shipperPublicKeyJWK, documentHash, true, null, carrierPrivateKeyFromPem);
                const isValid2 = KJUR.jws.JWS.verifyJWT(issueBLtdt.asJWT, carrierPublicKeyFromPem, {alg: ['RS256']});
                console.log("valid JWT?: ", isValid2);
                await fetch('/api/v1/addTransportDocumentTransfer', {
                method: 'post',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tdtHash : await issueBLtdt.tdtHash(),
                    transportDocumentTransfer: issueBLtdt.asJWT
                    })
                });

                location.href = "transportdocumenttransfer.html?id=" + await issueBLtdt.tdtHash();
            });
        }
    </script>
</html>
